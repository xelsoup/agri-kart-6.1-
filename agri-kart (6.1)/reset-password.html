<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password | Agri-Kart</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: "class" }
  </script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  </style>
  <link rel="icon" href="public/placeholder-logo.png">
  <script src="js/utils.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const stepRequest = document.getElementById('step-request');
      const stepVerify = document.getElementById('step-verify');
      const requestForm = document.getElementById('request-form');
      const verifyForm = document.getElementById('verify-form');
      const emailInput = document.getElementById('reset-email');
      const codeInput = document.getElementById('reset-code');
      const newPasswordInput = document.getElementById('new-password');
      const confirmPasswordInput = document.getElementById('confirm-new-password');

      function getRegisteredUsers() {
        try { const raw = localStorage.getItem('registeredUsers'); return raw ? JSON.parse(raw) : []; } catch { return []; }
      }
      function setRegisteredUsers(users) { localStorage.setItem('registeredUsers', JSON.stringify(users)); }
      function createResetRecord(email, code) {
        const rec = { email, code, expires: Date.now() + 15 * 60 * 1000 };
        localStorage.setItem('passwordResetRecord', JSON.stringify(rec));
      }
      function getResetRecord() {
        try { const raw = localStorage.getItem('passwordResetRecord'); return raw ? JSON.parse(raw) : null; } catch { return null; }
      }
      function clearResetRecord() { localStorage.removeItem('passwordResetRecord'); }

      function genCode() { return Math.floor(100000 + Math.random() * 900000).toString(); }
      function getWebmailUrl(email) {
        const domain = (email.split('@')[1] || '').toLowerCase();
        if (domain === 'gmail.com') return 'https://mail.google.com';
        if (domain === 'yahoo.com' || domain === 'ymail.com') return 'https://mail.yahoo.com';
        if (domain === 'outlook.com' || domain === 'hotmail.com' || domain === 'live.com') return 'https://outlook.live.com/mail';
        if (domain === 'icloud.com' || domain === 'me.com' || domain === 'mac.com') return 'https://www.icloud.com/mail';
        return `mailto:${email}`;
      }

      requestForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const email = emailInput.value.trim();
        const users = getRegisteredUsers();
        const exists = users.some(u => (u.email || '').toLowerCase() === email.toLowerCase());
        if (!exists) {
          showNotification('No account found for this email', 'error');
          return;
        }
        const code = genCode();
        createResetRecord(email, code);
        showNotification('We sent a 6-digit code to your email', 'success');
        setTimeout(() => { window.open(getWebmailUrl(email), '_blank'); }, 400);
        stepRequest.classList.add('hidden');
        stepVerify.classList.remove('hidden');
        codeInput.focus();
      });

      confirmPasswordInput.addEventListener('input', function() {
        if (confirmPasswordInput.value !== newPasswordInput.value) {
          confirmPasswordInput.setCustomValidity('Passwords do not match');
        } else {
          confirmPasswordInput.setCustomValidity('');
        }
      });

      verifyForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const rec = getResetRecord();
        if (!rec) { showNotification('Reset session expired. Please request a new code.', 'error'); return; }
        if (Date.now() > rec.expires) { clearResetRecord(); showNotification('Code expired. Please request a new one.', 'error'); return; }

        if (codeInput.value.trim() !== rec.code) { showNotification('Invalid code', 'error'); return; }
        if (newPasswordInput.value.length < 8) { showNotification('Password must be at least 8 characters', 'error'); return; }
        if (newPasswordInput.value !== confirmPasswordInput.value) { showNotification('Passwords do not match', 'error'); return; }

        const users = getRegisteredUsers();
        const idx = users.findIndex(u => (u.email || '').toLowerCase() === rec.email.toLowerCase());
        if (idx === -1) { showNotification('Account not found', 'error'); return; }
        users[idx].password = newPasswordInput.value;
        setRegisteredUsers(users);
        clearResetRecord();
        showNotification('Password updated successfully. You can now log in.', 'success');
        setTimeout(() => { window.location.href = 'auth.html'; }, 1200);
      });
    });
  </script>
</head>
<body class="min-h-screen bg-white">
  <main class="container mx-auto max-w-md px-4 py-12">
    <h1 class="text-3xl font-bold text-center">Reset your password</h1>
    <p class="mt-2 text-center text-muted-foreground">We will send a verification code to your email.</p>

    <section id="step-request" class="mt-8">
      <form id="request-form" class="space-y-4">
        <div class="space-y-2">
          <label for="reset-email" class="text-sm font-medium">Email</label>
          <input id="reset-email" type="email" required class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
        </div>
        <button type="submit" class="w-full h-10 rounded-md bg-primary text-primary-foreground hover:bg-primary/90">Send code</button>
      </form>
    </section>

    <section id="step-verify" class="mt-8 hidden">
      <form id="verify-form" class="space-y-4">
        <div class="space-y-2">
          <label for="reset-code" class="text-sm font-medium">Verification code</label>
          <input id="reset-code" type="text" inputmode="numeric" pattern="\\d{6}" required class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm" placeholder="6-digit code">
        </div>
        <div class="space-y-2">
          <label for="new-password" class="text-sm font-medium">New password</label>
          <input id="new-password" type="password" minlength="8" required class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
        </div>
        <div class="space-y-2">
          <label for="confirm-new-password" class="text-sm font-medium">Confirm new password</label>
          <input id="confirm-new-password" type="password" minlength="8" required class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
        </div>
        <button type="submit" class="w-full h-10 rounded-md bg-primary text-primary-foreground hover:bg-primary/90">Update password</button>
      </form>
    </section>
  </main>
</body>
</html>


